version: 1
backend:
  phases:
    preBuild:
      commands:
        - echo "Setting up Python environment for Amplify"
        - echo "Python version:"
        - python3 --version
        - echo "Pip version:"
        - python3 -m pip --version
        - echo "Current directory:"
        - pwd
        - echo "Listing root directory:"
        - ls -la
        - echo "Changing to backend directory"
        - cd backend
        - echo "Listing backend directory:"
        - ls -la
        - echo "Installing Python dependencies from requirements-prod.txt"
        - python3 -m pip install --user --upgrade pip
        - python3 -m pip install --user -r requirements-prod.txt --verbose
    build:
      commands:
        - echo "Starting build phase"
        - echo "Current directory in build:"
        - pwd
        - echo "Listing current directory:"
        - ls -la
        - echo "Changing to backend directory for migrations"
        - cd backend
        - echo "Checking installed packages:"
        - python3 -m pip list
        - echo "Adding user local bin to PATH"
        - export PATH="/root/.local/bin:$PATH"
        - echo "Running database migrations"
        - /root/.local/bin/python3 -m alembic upgrade head || echo "Skipping migrations - database may not be configured"
        - echo "Backend build completed successfully"
    postBuild:
      commands:
        - echo "Backend post-build setup completed"
  artifacts:
    baseDirectory: backend
    files:
      - '**/*'
  cache:
    paths:
      - ~/.cache/pip/**/*
frontend:
  phases:
    preBuild:
      commands:
        - cd frontend/frontend
        - npm ci
    build:
      commands:
        - cd frontend/frontend
        - npm run build
  artifacts:
    baseDirectory: frontend/frontend/.next
    files:
      - '**/*'
  cache:
    paths:
      - frontend/frontend/node_modules/**/*